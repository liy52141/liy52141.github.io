<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="Sky.js"></script>
    <script src="Land.js"></script>
    <script src="Pipe2.js"></script>
    <script src="Bird.js"></script>

    <style>
        #canvas {
            border: 1px solid #000;
        }
    </style>
</head>
<body>
<canvas width="800" height="600" id="canvas"></canvas>
<script>
    var canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");

    //1. 加载所有的图片
    var skyImage = new Image();
    var landImage = new Image();
    var pipe1Image = new Image();
    var pipe2Image = new Image();
    var birdsImage = new Image();

    skyImage.src = "img/sky.png";
    landImage.src = "img/land.png";
    pipe1Image.src = "img/pipe1.png";
    pipe2Image.src = "img/pipe2.png";
    birdsImage.src = "img/birds.png";

    var imagesArr = [skyImage, landImage, pipe1Image, pipe2Image, birdsImage];
    var count = 0;

    imagesArr.forEach(function (image) {
        image.onload = function () {
            count += 1;
            if (count == imagesArr.length) {
                console.log("所有图片都加载成功了");

                //角色数组
                var roleArrs = [];

                //1. 准备所有的角色
                function createRoles() {
                    //1. 创建所有的天空对象
                    for (var i = 0; i<2; i++) {
                        //天空对象的参数
                        var info = {
                            image: skyImage,
                            x: i * skyImage.width,
                            context: context,
                            canvas: canvas
                        };
                        //创建天空对象
                        var sky = new Sky(info);
                        //将天空对放到角色数组中
                        roleArrs.push(sky);
                    }

                    //2. 创建所有的陆地对象
                    for (var i = 0; i<4; i++) {
                        var info = {
                            image: landImage,
                            x: i * landImage.width,
                            canvas: canvas,
                            context: context
                        };

                        //创建陆地对象
                        var land = new Land(info);
                        //归队
                        roleArrs.push(land);
                    }

                    //3. 创建所有的管道对象
                    var gap = (canvas.width - pipe2Image.width*6)/5
                    for (var i = 0; i<6; i++) {
                        var info = {
                            x: 300 + i * (pipe2Image.width + gap),
                            gap: gap,
                            topImage: pipe2Image,
                            bottomImage: pipe1Image,
                            context: context,
                            canvas: canvas,
                            bottomOffset: landImage.height
                        }

                        var pipe = new Pipe2(info);
                        roleArrs.push(pipe);
                    }

                    //4. 创建小鸟对象
                    var info = {
                        image: birdsImage,
                        x: 100,
                        y: 100,
                        canvas: canvas,
                        context: context
                    };

                    var bird = new Bird(info);

                    roleArrs.push(bird);
                }

                //创建所有角色
                createRoles();

                console.log(roleArrs);

                //点击屏幕，让小鸟往上蹦
                canvas.addEventListener("click", function () {
                    roleArrs[roleArrs.length - 1].speed = - 0.2;
                });

                //绘制
                function action() {
                    //1. 先把画布清空掉
                    context.clearRect(0, 0, canvas.width, canvas.height);

                    //创建玻璃纸
                    context.beginPath();

                    //2. 遍历角色数组，让各个角色自已找位置，自已完成自己的绘制
                    roleArrs.forEach(function (role) {
                        role.draw();
                    });

                    //写文字（时间统计）
                    var now = new Date();
                    var deltaTime = now - startTime;
                    var s = Math.floor(deltaTime / 1000);
                    var h = Math.floor(s / 3600);
                    var m = Math.floor(s / 60);
                    s = s % 60;

                    var text = "您坚持了"+h+"小时"+m+"分"+s+"秒";
                    context.textAlign = "right";
                    context.fillStyle = "hotpink";
                    context.textBaseline = "top";
                    context.font = "30px 微软雅黑";
                    context.fillText(text, canvas.width, 0);

                    //3. 小鸟死亡事件处理
                    //小鸟掉地上了
                    var bird = roleArrs[roleArrs.length - 1];
                    if(bird.y >= canvas.height - landImage.height - bird.h) {
                        return;
                    }

                    //小鸟撞柱子上了
                    //在画布上把柱子的路径画出来， 但是不做stroke或者fill的操作
                    if (context.isPointInPath(bird.x + bird.w/2, bird.y + bird.h/2)) {
                        return;
                    };

                    //开始执行动画
                    window.requestAnimationFrame(action);
                }

                //开始计算时间
                var startTime = new Date();

                action();
            }
        }
    });


</script>
</body>
</html>